# Nginx 全局配置
user root;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /run/nginx.pid;

events {
    # 每个工作进程最大连接数
    worker_connections 1024;
    use epoll;  # Linux 推荐使用 epoll
}

http {
    # 包含 MIME 类型映射
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # 日志格式定义
    log_format main  '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    # 开启 Gzip 压缩（可选）
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;

    # 静态文件目录（测试文件和前端页面）
    root /var/www/speed-test;

    # 服务器配置
    server {
        listen 80;
        server_name localhost;

        # 设置字符编码
        charset utf-8;

        # 避免缓存测试文件（可选）
        location ~ \.(bin|js|css)$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # IP接口配置
        location /api/ip {
        default_type application/json;
        add_header Content-Type application/json;
        return 200 '{"ip": "$remote_addr"}';
        }

        # 1. 提供 50MB 测试文件下载（速度测试）
        location /download/testfile.bin {
            # 确保文件已生成（dd if=/dev/zero of=testfile.bin bs=1M count=50）
            add_header Content-Disposition "attachment";
            try_files $uri =404;

            # 优化大文件传输
            sendfile on;
            tcp_nopush on;
            keepalive_timeout 300;
            client_max_body_size 100M;
        }

        # 2. 延迟测试接口（模拟 Ping）
        location /ping {
            # 返回 200 OK，延迟由网络决定
            return 200 '{"status": "ok"}';
            add_header Content-Type application/json;
        }

        # 3. 静态文件服务（前端页面、CSS、JS）
        location / {
            try_files $uri $uri/ /index.html;
        }

        # 4. 错误页面（可选）
        error_page 404 /404.html;
        location = /404.html {
            internal;
        }
    }
}